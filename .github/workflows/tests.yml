name: Tests

on: [push, pull_request]

# We use caching for Docker-based jobs:
# https://evilmartians.com/chronicles/build-images-on-github-actions-with-docker-layer-caching
# https://dev.to/dtinth/caching-docker-builds-in-github-actions-which-approach-is-the-fastest-a-research-18ei

jobs:
  nix:
    strategy:
      matrix:
        variant:
        - bcdb-llvm10
        - bcdb-llvm11
        - bcdb-llvm12
        - bcdb-llvm13
        - bcdb-clang-sanitize
        - bcdb-without-optional-deps
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
      with:
        submodules: true
    - uses: cachix/install-nix-action@v16
    - uses: cachix/cachix-action@v10
      with:
        name: bcdb
        authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
        signingKey: '${{ secrets.CACHIX_SIGNING_KEY }}'
    - run: nix-build -A ${{ matrix.variant }}
    - name: Slack Notification
      if: failure()
      uses: lazy-actions/slatify@v3.0.0
      with:
        job_name: '*Nix Test*'
        commit: true
        type: ${{ job.status }}
        url: ${{ secrets.SLACK_WEBHOOK }}
        token: ${{ secrets.GITHUB_TOKEN }}

  ubuntu-lts-upstream-llvm:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
      with:
        submodules: true
    - name: Cache Docker Layers
      uses: actions/cache@v2
      with:
        path: /tmp/.buildx-cache
        key: ubuntu-lts-upstream-llvm-buildx-${{ github.sha }}
        restore-keys: ubuntu-lts-upstream-llvm-buildx-
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v1
    - name: Build
      uses: docker/build-push-action@v2
      with:
        context: .
        file: experiments/dockerfiles/ubuntu-lts-upstream-llvm.docker
        push: false
        tags: bcdb-ubuntu
        cache-from: type=local,src=/tmp/.buildx-cache
        cache-to: type=local,dest=/tmp/.buildx-cache-new
    - name: Move cache
      run: |
        rm -rf /tmp/.buildx-cache
        mv /tmp/.buildx-cache-new /tmp/.buildx-cache
    - name: Slack Notification
      if: failure()
      uses: lazy-actions/slatify@v3.0.0
      with:
        job_name: '*Ubuntu Test*'
        commit: true
        type: ${{ job.status }}
        url: ${{ secrets.SLACK_WEBHOOK }}
        token: ${{ secrets.GITHUB_TOKEN }}
